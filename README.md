## Majorskins backend

Majorskins — веб-приложение для азартных игр, ставками в которых являются скины из игры CS:GO.
Пример: Skinarena.com, csgofast.com

### Глоссарий

  API ключ (API key) — ключ Steam API, который нужен для взаимодействия сайта или бота с API. Получается в профиле пользователя в Steamcommunity. Привязывается к домену.

	Бет (bet) — ставка.
	
	Билет, тикет (ticket) — номер в определенном диапазоне, присваиваемый игроку для определения победителя в раунде
	
	Бот (bot) — подпрограмма, управляющая «операционным» (находящимся в собственности казино) аккаунтом Steam и осуществляющая передачу вещей из инвентаря игрока в инвентарь этого аккаунта и обратно
	
	Гарантия (guarantee) — предмет, который вносится в раунд самим казино. За ним не закрепляются билеты, победитель забирает его вместе с выигрышем.
	
	Депозит (deposit, depo) — предметы, которые игрок внёс на сайт или выиграл, находящиеся на Steam аккаунте бота, но закрепленные за этим игроком.
	
	Инвентарь (inventory) — 

	1) предметы, привязанные к аккаунту Steam игрока, фактически находящиеся в инвентаре бот-аккаунта
	
	2) инвентарь игрока в Steam

	Лимит (limit) — какое-либо ограничение, определяющее правила игры в руме
	
	Пот (pot) — все предметы, поставленные на кон в текущем раунде
	
	Раунд (round) — сессия игры, ограниченная по времени / иным условиям
	
	Раздача (giveaway) — тип розыгрыша, в котором разыгрывается один гарантированный предмет.
	
	Рейк (rake) — комиссия в виде предметов, взимаемая сайтом за свои услуги
	
	Реферальная система (affiliate program) — система поощрения игроков за привлечение новых игроков
	
	Рум (room) — комната, секция сайта, в которой осуществляется игра
	
	Скин, предмет, айтем (skin, item) — предмет из игры CS:GO, подлежащий обмену между игроками.
	
	Стиманалист (steamanalyst) — сторонний API для получения цен на предметы, цены на которые нельзя получить через Steam API. 
	
	Стим аккаунт (Steam account) — аккаунт пользователя в Steam, 
	
	Стим вэлью (Steam value) — стоимость вещей в воображаемых единицах Steam. Составляет ~1.3х - ~2х от стоимости в долларах США при 	выводе.
	
	Стим левел (Steam level) — уровень аккаунта Steam, нужен для определения подлинности аккаунта
	
	Трейд оффер (trade offer) — предложение обмена предметами
	
	Трейдабл (tradable) — предмет, подлежащий обмену. Соответственно нонтрейдабл — предмет, обмену не подлежащий.
	
	Трейдбан (trade ban) — блокировка возможности обмениваться предметами. Распространяется на весь аккаунт. Бывает временный и 	постоянный.
	
	Трейдлинк (trade link) — ссылка, необходимая для отправки оффера игроку. Игрок должен предоставить её добровольно.
	
	Трейдлок (trade lock) — блокировка возможности обмена, распространяется на конкретный предмет. Обычно временная.
	
	Эскроу (escrow) — механизм предотвращения кражи предметов, благодаря которому трейд проходит в течении трех дней, если он не 	был подтвержден с помощью мобильного аутентификатора.
	
### Описание сущностей

#### Пользователь

	 int id
	 int steamid
	 string avatar
	 string avatarmedium
	 string name
	 int steamlevel
	 string tradelink
	 bool eula

#### Предмет (сущность)

	 int id
	 string name
	 float value
	 string color
	 string name_color

#### Предмет (объект)

	 int id
	 int item_id
	 int user_id
	 int bot_id

#### Комната
  
  	int id
  	bool is_active
  	string name
  	object limits 
  
##### Лимиты комнат

Базовый тип игры

	int   item_limit_max     — Задаёт максимальное количество предметов в поте. При достижении этого лимита розыгрыш всегда 	завершается.
	int   bet_item_limit_max — Задаёт максимальное общее количество предметов в поте от одного игрока
	float bet_value_min      — Задаёт минимальный размер ставки
	float bet_value_max      — Задаёт максимальный общий размер ставки
	int   player_limit       — Задаёт количество игроков, после которого стартует таймер
	int   time_limit         — Задаёт ограничение времени после старта таймера. При достижении этого лимита розыгрыш всегда 	завершается.
	bool  time_enable        — Включает ограничение time_limit если true

Лимиты для специальных типов игры

	array allowed_items  	 — Массив идентификаторов предметов, разрешенных в данном типе игры
	array shares		 — Массив чисел. Количество значений равно количеству победителей, значение равно доле каждого.
	int team_limit     	 — Количество игроков в команде.
	float global_pot_limit   — Предельная сумма в поте.

#### Розыгрыш

	int id — идентификатор розыгрыша
	int mode — режим розыгрыша (тип комнаты)
	int time_start — время начала розыгрыша
	int status — текущая фаза
	float bank — текущий банк
	float winning_number — секретное число
	string hash — хеш числа
	string salt — соль
	int winning_ticket — номер выигрышного билета
	array items — предметы в розыгрыше

		int item_id — ID предмета
		int deposit_id — ID депозита
		int user_id — ID владельца
		float price — стоимость предмета в steam value на момент ставки
		int tickets_start — номер первого билета, закрепленного за этим предметом
		int tickets_end — номер последнего билета, закрепленного за этим предметом
		
	array players — игроки
	
		int user_id = ID игрока
		float chance — шанс на победу
		bool is_winner — является ли победителем
		
		
### Описание процессов

#### Добавление пользователя

Пользователь авторизуется через Steamcommunity.com посредством OpenID. Steamcommunity отдаёт нам все данные пользователя. Если пользователь с таким steamid есть в базе, авторизуем его, если нет, то добавляем нового.
Проверяем, отметил ли он EULA чекбокс и есть ли у него необходимый Steam level. Если да, авторизуем его.

#### Взаимодействие с инвентарем пользователя в Steam

Если у нас есть steamid пользователя, мы можем получить инвентарь. Для этого мы посылаем запрос на Steamcommunity.com и получаем ответ в виде JSON.


Запрос:

	GET http://steamcommunity.com/profiles/ _steamid_ /inventory/json/730/2/


Структура ответа — Важные для нас поля:

**_rgInventory_**

	id — уникальный идентификатор предмета в БД Steam. При передаче предмета может меняться, полагаться на него можно только в 	пределах одного инвентаря (при создании трейд оффера от игрока к боту).
	classid, instanceid — вспомогательные идентификаторы предмета, нужны для поиска описания
	amount — количество, для абсолютного большинства предметов из CS:GO равно 1, при передаче иного вызовется ошибка

**_rgDescriptions_**

Пример объекта (комментариями отмечены важные поля)

```javascript
"310777314_302028390":
{"appid":"730",  // id приложения
"classid":"310777314",
"instanceid":"302028390",
"icon_url":"ссылка", // ссылка на изображение предмета
"icon_url_large":"ссылка", // ссылка на большое изображение предмета
"icon_drag_url":"",
"name":"текст",
"market_hash_name":"Desert Eagle | Mudder (Field-Tested)",  // наименование предмета, необходимо для опознания
"market_name":"текст", 
"name_color":"D2D2D2",  // цвет названия
"background_color":"",
"type":"текст",
"tradable":1, // возможен ли обмен
"marketable":1, // возможно ли выставление на маркет
"commodity":0,
"market_tradable_restriction":"7", 
"descriptions":[
{"type":"html","value":"текст"},
],
"actions":[
{"name":"текст",
"link":"steam:\/\/rungame\/730\/76561202255233023\/+csgo_econ_action_preview%20S%owner_steamid%A%assetid%D7361250442143090407"} // ссылка для просмотра предмета в игре, нужна в депозите, для раздач
],
"market_actions":[
{"name":"текст",
"link":"steam:\/\/rungame\/730\/76561202255233023\/+csgo_econ_action_preview%20M%listingid%A%assetid%D7361250442143090407"
],
"tags":[
{"internal_name":"CSGO_Type_Pistol","name":"текст","category":"Type","category_name":"текст"},
{"internal_name":"weapon_deagle","name":"Desert Eagle","category":"Weapon","category_name":"текст"},		{"interal_name":"set_lake","name":"текст","category":"ItemSet","category_name":"текст"},
{"internal_name":"normal","name":"текст","category":"Quality","category_name":"текст"},
{"internal_name":"Rarity_Uncommon_Weapon","name":"текст","category":"Rarity","color":"5e98d9","category_name":"текст"}, // color — цвет, отображающий редкость
{"internal_name":"WearCategory2","name":"текст","category":"Exterior","category_name":"текст"}]}
```
Проверяем market_hash_name, сверяем с нашей базой вещей. Если нет такой вещи в БД, добавляем.

Стоимость предмета получается через API стороннего сервиса цен (Steamanalyst, Steamlytics, Backpack.tf или подобный). Сервис отдаёт цены сразу на все предметы с периодичностью в 6 часов. Запрашивать цены по отдельности есть смысл только торговой площадке, для лотереи этого вполне достаточно.

Заблокированные предметы

По умолчанию мы не принимаем предметы, которые 
* — имеют appid отличный от 730
* — не являются tradable (находятся в tradelock, за это отвечает один и тот же параметр)
* — не имеют стоимости
* — стоят менее лимита item_value_min
* — содержат в названии слово Souvenir


