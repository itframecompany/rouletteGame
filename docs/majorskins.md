### Глоссарий (будет дополняться)
	
	Бет (bet) — ставка.
	
	Билет, тикет (ticket) — номер в определенном диапазоне, присваиваемый игроку для определения победителя в раунде
	
	Бот (bot) — подпрограмма, управляющая «операционным» (находящимся в собственности казино) аккаунтом Steam и осуществляющая передачу вещей из инвентаря игрока в инвентарь этого аккаунта и обратно
	
	Гарантия (guarantee) — предмет, который вносится в раунд самим казино. За ним не закрепляются билеты, победитель забирает его вместе с выигрышем.
	
	Депозит (deposit, depo) — предметы, которые игрок внёс на сайт или выиграл, находящиеся на Steam аккаунте бота, но закрепленные за этим игроком.
	
	Инвентарь (inventory) — 

	1) предметы, привязанные к аккаунту Steam игрока, фактически находящиеся в инвентаре бот-аккаунта
	
	2) инвентарь игрока в Steam

	Лимит (limit) — какое-либо ограничение, определяющее правила игры в руме
	
	Пот (pot) — все предметы, поставленные на кон в текущем раунде
	
	Раунд (round) — сессия игры, ограниченная по времени / иным условиям
	
	Раздача (giveaway) — тип розыгрыша, в котором разыгрывается один гарантированный предмет.
	
	Рейк (rake) — комиссия в виде предметов, взимаемая сайтом за свои услуги
	
	Реферальная система (affiliate program) — система поощрения игроков за привлечение новых игроков
	
	Рум (room) — комната, секция сайта, в которой осуществляется игра
	
	Скин, предмет, айтем (skin, item) — предмет из игры CS:GO, подлежащий обмену между игроками.
	
	Стиманалист (steamanalyst) — сторонний API для получения цен на предметы, цены на которые нельзя получить через Steam API. 
	
	Стим аккаунт (Steam account) — аккаунт пользователя в Steam, 
	
	Стим вэлью (Steam value) — стоимость вещей в воображаемых единицах Steam. Составляет ~1.3х - ~2х от стоимости в долларах США при 	выводе.
	
	Стим левел (Steam level) — уровень аккаунта Steam, нужен для определения подлинности аккаунта
	
	Трейд оффер (trade offer) — предложение обмена предметами
	
	Трейдабл (tradable) — предмет, подлежащий обмену. Соответственно нонтрейдабл — предмет, обмену не подлежащий.
	
	Трейдбан (trade ban) — блокировка возможности обмениваться предметами. Распространяется на весь аккаунт. Бывает временный и 	постоянный.
	
	Трейдлинк (trade link) — ссылка, необходимая для отправки оффера игроку. Игрок должен предоставить её добровольно.
	
	Трейдлок (trade lock) — блокировка возможности обмена, распространяется на конкретный предмет. Обычно временная.
	
	Эскроу (escrow) — механизм предотвращения кражи предметов, благодаря которому трейд проходит в течении трех дней, если он не 	был подтвержден с помощью мобильного аутентификатора.
	

### Общая структура

#### Клиентская часть

Фронтэнд. Представляет собой одностраничное приложение. Взаимодействует с сервером через веб-сокеты.
Бэкофис (админпанель) — одностраничное приложение для вывода статистики и состояния, управления параметрами комнат.

#### Серверная часть (структура, которая намечалась у нас ранее)

##### FrontendController

Отвечает за обработку пользовательского ввода и взаимодействие с веб-мордой

##### UserController

Отвечает за обработку пользовательских данных (данные аккаунта Steam и содержимое инвентаря) и сопряженные с этим запросы к Steam API (авторизация, которая осуществляется исключительно через Steam посредством OpenID и парсинг предметов на аккаунте игрока)

##### LotteryController

Отвечает за проведение розыгрышей

##### BotController

Отвечает за взаимодействие с ботами, отправляет им указания принять или отдать предметы

#### Боты

Боты запущены на отдельных небольших серверах группами по 10 шт на сервер.
Бот получает от бот-контроллера команду принять / выдать вещи игроку и создаёт трейд оффер с соответствующими предметами, который игрок должен принять. После этого происходит передача вещей между игроком и ботом, бот возвращает ответ бот-контроллеру и в депозит игрока вносятся соответствующие изменения. 

Все функции взаимодействия бота со Steam API у нас уже реализованы, их подводные камни известны.
	
	
### Описание лимитов

#### Лимиты комнат (для базового типа игры)

	int   item_limit_max     — Задаёт максимальное количество предметов в поте. При достижении этого лимита розыгрыш всегда 	завершается.
	
	int   bet_item_limit_max — Задаёт максимальное общее количество предметов в поте от одного игрока
	
	float bet_value_min      — Задаёт минимальный размер ставки
	
	float bet_value_max      — Задаёт максимальный общий размер ставки
	
	int   player_limit       — Задаёт количество игроков, после которого стартует таймер
	
	int   time_limit         — Задаёт ограничение времени после старта таймера. При достижении этого лимита розыгрыш всегда 	завершается.
	
	bool  time_enable        — Включает ограничение time_limit если true

#### Лимиты для специальных типов игры

	array allowed_items  	 — Массив идентификаторов предметов, разрешенных в данном типе игры
	
	array shares		 — Массив чисел. Количество значений равно количеству победителей, значение равно доле каждого.

	int team_limit     	 — Количество игроков в команде.
	
	float global_pot_limit   — Предельная сумма в поте.


#### Общие лимиты

	inventory_limit  — Задаёт размер депозита игрока. Если этот лимит превышен, игрок не может вносить дополнительные предметы на 	депозит.
	
	item_value_min   — Задаёт минимальную стоимость предмета, который можно вносить на депозит.


### Параметры розыгрыша


	(int) id — идентификатор розыгрыша

	(int) mode — режим розыгрыша

	(int) time_start — время начала розыгрыша

	(int) status — текущая фаза

	(float) bank — текущий банк

	(float) winning_number — секретное число

	(string) hash — хеш числа

	(string) salt — соль

	(int) winning_ticket — номер выигрышного билета

	(array) items — предметы в розыгрыше

		(int) item_id — ID предмета
		(int) deposit_id — ID депозита
		(int) user_id — ID владельца
		(float) price — стоимость предмета в steam value на момент ставки
		(int) tickets_start — номер первого билета, закрепленного за этим предметом
		(int) tickets_end — номер последнего билета, закрепленного за этим предметом
		
	(array) players — игроки
	
		(int) user_id = ID игрока
		(float) chance — шанс на победу
		(bool) is_winner — является ли победителем


### Механизм розыгрыша в системе Provably Fair (с верификацией)


Фаза 0. Разогрев (warmup)

	Случайным образом генерируется длинная дробь (17 или более знаков после запятой) в диапазоне от 0 до 1, («прикуп», хехе) которая используется для определения номера выигрышного билета. Это число хешируется, хеш отображается в клиентской части.

Фаза 1. Игра (game)

	Скрипт проверяет состояние до тех пор, пока не будет выполнено какое-либо из условий завершения розыгрыша. Ставки принимаются. Игрокам сразу же начисляются билеты в соответствии с их ставками и в том порядке, в котором они ставили (обычно 1 цент — 1 билет).

Фаза 2. Определение победителя (winner picking)

	Количество билетов умножается на «прикуп» и таким образом определяется выигрышный билет.
	Например, у нас всего 45000 билетов, а winning_number равен 0.36263426738, тогда выигрышный номер билета равен floor()

Фаза 4. Конец игры (finalize)

	По номеру билета определяется победитель, предметы из банка перераспределяются между победителем и казино, начисляются бонусы партнерской программы.

Фаза 5 — Розыгрыш завершен (sealed)

	Информация об исходе розыгрыша отображается в клиентской части			
			
	
			
## Комнаты

### Классические комнаты

#### Classic Unlimited

Классическая безлимитная комната. Отсчёт стартует, как только есть ставки от 2 игроков.

    item_limit_max 8X
    bet_item_limit_max X
    bet_value_min Y
    bet_value_max null
    player_limit 2
    time_limit 30
    time_enable true

#### Classic Limited

Классическая лимитная комната. Отсчёта нет, розыгрыш происходит, как только достигнут лимит вещей в поте.

    item_limit_max 8X
    bet_item_limit_max X
    bet_value_min 0
    bet_value_max Y
    player_limit null
    time_limit null
    time_enable false

### Специальные комнаты

#### Sit-n-Go

В этой комнате можно играть только на специальный (не Steam) предмет — SnG Ticket, который предварительно обменивается на другие предметы. Победителей несколько, каждый получает долю билетов, которые можно обменять обратно на предметы.

    item_limit_max 10
    bet_item_limit_max 1
    bet_value_min 0
    bet_value_max 10
    player_limit null
    time_limit null
    time_enable false
    allowed_items [id1, id2, idN]
    shares [5,3,1]

#### 5v5

В этой комнате играют две команды — CT и T. Игра начинается, когда обе команды полностью укомплектованы игроками.
Здесь диапазоны билетов игроков обратно пропорциональны ставкам, а «попадание» в диапазон билетов означает выбывание из игры.
Выигрышный номер выбрасывается множество раз, до момента, когда одна из команд полностью выбывает из игры, «оставшиеся в живых» сохраняют свои ставки и делят выигрыш пропорционально им.

    item_limit_max 10X
    bet_item_limit_max X
    bet_value_min Y
    bet_value_max null
    player_limit 10
    time_limit Z
    time_enable true
    team_limit 5

#### Глобальный пот

В этой комнате розыгрыш идёт до тех пор, пока не будет достигнут лимит пота, скажем, миллион. При достижении лимита приём ставок прекращается. Розыгрыш проводится не с помощью ГСЧ, а на стриме, номера билетов вводятся вручную.

    item_limit_max null
    bet_item_limit_max X
    bet_value_min Y
    bet_value_max null
    player_limit null
    time_limit null
    time_enable false
    shares [m1,m2,m3,mN]
    global_pot_limit M

#### Раздача

В этой комнате призовой предмет один и назначается казино. Ставить можно только на специальный (не Steam) предмет — Raffle Ticket, который предварительно обменивается на другие предметы. Розыгрыш идёт до тех пор, пока не будет достигнут лимит времени или не будет достигнут предел предметов в розыгрыше. Победитель получает только один предмет (гарантию).

    item_limit_max Х
    bet_item_limit_max Y
    bet_value_min null
    bet_value_max null
    player_limit null
    time_limit Z
    time_enable true
    allowed_items [id1, id2, idN]


## Предмет

**Предмет** (айтем, скин) содержится в инвентаре игрока, который представляет собой массив данных в формате json. Инвентарь запрашивается не через api, а непосредственно через профиль игрока на steamcommunity.com.

Сведения о предмете содержатся в объектах rgInventory и rgDescriptions.

#### Важные для нас поля:

**_rgInventory_**

	id — уникальный идентификатор предмета в БД Steam. При передаче предмета может меняться, полагаться на него можно только в 	пределах одного инвентаря (при создании трейд оффера от игрока к боту).
	classid, instanceid — вспомогательные идентификаторы предмета, нужны для поиска описания
	amount — количество, для абсолютного большинства предметов из CS:GO равно 1, при передаче иного вызовется ошибка

**_rgDescriptions_**

Пример объекта (комментариями отмечены важные поля)

```javascript
"310777314_302028390":
{"appid":"730",  // id приложения
"classid":"310777314",
"instanceid":"302028390",
"icon_url":"ссылка", // ссылка на изображение предмета
"icon_url_large":"ссылка", // ссылка на большое изображение предмета
"icon_drag_url":"",
"name":"текст",
"market_hash_name":"Desert Eagle | Mudder (Field-Tested)",  // наименование предмета, необходимо для опознания
"market_name":"текст", 
"name_color":"D2D2D2",  // цвет названия
"background_color":"",
"type":"текст",
"tradable":1, // возможен ли обмен
"marketable":1, // возможно ли выставление на маркет
"commodity":0,
"market_tradable_restriction":"7", 
"descriptions":[
{"type":"html","value":"текст"},
],
"actions":[
{"name":"текст",
"link":"steam:\/\/rungame\/730\/76561202255233023\/+csgo_econ_action_preview%20S%owner_steamid%A%assetid%D7361250442143090407"} // ссылка для просмотра предмета в игре, нужна в депозите, для раздач
],
"market_actions":[
{"name":"текст",
"link":"steam:\/\/rungame\/730\/76561202255233023\/+csgo_econ_action_preview%20M%listingid%A%assetid%D7361250442143090407"
],
"tags":[
{"internal_name":"CSGO_Type_Pistol","name":"текст","category":"Type","category_name":"текст"},
{"internal_name":"weapon_deagle","name":"Desert Eagle","category":"Weapon","category_name":"текст"},		{"interal_name":"set_lake","name":"текст","category":"ItemSet","category_name":"текст"},
{"internal_name":"normal","name":"текст","category":"Quality","category_name":"текст"},
{"internal_name":"Rarity_Uncommon_Weapon","name":"текст","category":"Rarity","color":"5e98d9","category_name":"текст"}, // color — цвет, отображающий редкость
{"internal_name":"WearCategory2","name":"текст","category":"Exterior","category_name":"текст"}]}
```

#### Стоимость предмета

Стоимость предмета получается через API стороннего сервиса цен (Steamanalyst, Steamlytics, Backpack.tf или подобный). Сервис отдаёт цены сразу на все предметы с периодичностью в 6 часов. Запрашивать цены по отдельности есть смысл только торговой площадке, для лотереи этого вполне достаточно.

#### Заблокированные предметы

По умолчанию мы не принимаем предметы, которые 
* — имеют appid отличный от 730
* — не являются tradable (находятся в tradelock, за это отвечает один и тот же параметр)
* — не имеют стоимости
* — стоят менее лимита item_value_min
* — содержат в названии слово Souvenir

#### Хранение информации о предметах в БД (на примере skinny, другого проекта).

Информация о предметах содержится в двух таблицах — items и deposit.
Таблица items содержит описание _всех известных_ предметов. Поля 

* id — ID предмета (это не id из rgInventory, мы генерим его сами)
* value — стоимость

Далее поля в соответствии с rgDescriptions

* name = market_hash_name
* color
* name_color
* icon_url
* icon_url_large

Таблица deposit содержит информацию о конкретных предметах на депозитах игроков. Поля
* id — ID депозита
* item_id — ID предмета из таблицы items
* asset_id — ID предмета (из rgInventory), нужно для более тонкого управления предметами.
* user_id — ID пользователя
* bot_id — ID бота, уникален в рамках одного color.
* color - строка, идентификатор группы ботов.
* status — статус, см. ниже.
* touched - timestamp

Статусы

* deposit_pending - предмет ожидает депозита. Нужно отображать на фронтэнде с часами.
* deposit_failure - предмет не задепозитился. Не отображать.
* active - предмет активен и находится на депозите.
* withdraw_pending - предмет ожидает вывода. Нужно отображать на фронтэнде с часами.
* withdrawn - предмет выведен. Не отображать.
* counter - был сделан контроффер. Не отображать.

Все операции с предметами нужно отмечать, обновляя параметр touched. Предметы, которые имеют статус не active и которые имеют параметр touched меньше текущего времени минус неделя, нужно удалять. 

#### Рейк

Текущая формула расчёта рейка (на skinny)

Процент рейка зависит от шанса игрока на победу, так как при одинаковом рейке игроку невыгодно будет делать большие ставки.

	00-50 — 10%
	50-60 — 8%
	60-70 — 7%
	70-80 — 6%
	80-90 — 5%
	90-95 — 3%
	95-00 — 0%
	
Средний рейк — 7.75%

Чтобы обеспечить снятие наиболее выгодного предмета, используются два правила.
Первое: вещи из списка приоритетных (ключи, ножи и т.д.) уходят в рейк в первую очередь.
Второе: если в поте не нашлось вещи подходящей стоимости, алгоритм может взять вещь большей стоимости и вернуть игроку сдачу меньшими вещами. Для этой цели задается трешхолд (предел). Если в поте нет вещи, которая бы стоила меньше предела, рейк не будет снят. Если в поте есть только такая вещь, которая стоит меньше рейка, то рейк будет снят не в полном объёме. Потери, приходящиеся на эти ситуации, составят около 25%, поэтому фактический снятый рейк составит ~5.8%

#### Реферальная система

Система поощрения игроков за привлечение других игроков.
Каждый игрок может сгенерировать короткий URL (например, majorskins.com/r/example), при регистрации нового игрока по которому при внесении первого депозита он становится его рефералом.
При победе реферала в любом розыгрыше Х% от суммы снятого рейка (если рейк был снят) начисляется пригласившему. Если пригласивший сам является рефералом, то пригласивший его получает Х% от суммы его вознаграждения и так далее.


#### Принцип работы с трейд ботами

При депозите мы получаем список assetid предметов из steam инвентаря игрока и делаем запрос /deposit к серверу балансера так, как описано в botAPI.js

При этом эти предметы добавляются в инвентарь игрока на сайте со статусом pendingDeposit (отображение на фронтэнде - недоступный предмет с иконкой часов). Эти предметы пока не находятся в инвентаре нашего бота, поэтому производить любые операции с ними нельзя.

При любом действии с предметами мы обновляем их параметр touched (проставляем текущий timestamp) и логируем действие.

При ошибке вещам нужно присвоить статус failure и убрать их отображение. Через неделю (по timestamp) такие вещи можно удалять. Это нужно для того, чтобы исключить ситуацию с таймаутом steam API (такое бывает). При повторном запросе с тем же assetID создавать новые предметы.

При успешном запросе создаётся трейд оффер, и его идентификатор, а также идентификаторы бота возвращаются в ответе сервера.
Теперь нам нужно проверять статус оффера (запрос /trade) и в зависимости от ответа сервера присвоить вещам статус active или failure (условия прописаны в botAPI.js). Также при изменении статуса на active сервер пришлёт массив вещей с измененными assetID. Его нужно перебрать, сравнивая market_hash_name вещей, и при совпадении заменить assetid вещи на новый.

Запрос /withdraw работает точно так же, за исключением:

статус вещам присваиваем pendingWithdraw (тоже недоступны)

при успешном выводе assetID не обновляются, ставим статус withdrawn (выведено), такие вещи тоже убираем с фронтэнда и удаляем через неделю по timestamp.


#### Секретный токен 

При успешных запросах /deposit и /withdraw возвращается секретный токен, нужно сохранять его вместе с идентификатором трейд оффера в случае успешного создания трейд оффера. Время жизни токена - 30 минут.

При переходе по URL majorskins.com/verify/токен нужно проверять, соответствует ли токен данному авторизованному юзеру и не протух ли он. Если ок, отдавать на фронтэнд сообщение о том, что токен ок. Если нет, отдавать сообщение, что токен не ок. После этого токен из базы удалять. 
